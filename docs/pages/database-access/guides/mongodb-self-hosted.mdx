---
title: Database Access with Self-Hosted MongoDB
description: How to configure Teleport Database Access with self-hosted MongoDB
---

# Self-Hosted MongoDB

<Admonition type="note" title="Supported versions">
  Teleport Database Access supports MongoDB 3.6 and higher. Older versions have
  not been tested and are not guaranteed to work. MongoDB 3.6 was released in
  November 2017 and reached EOL in April 2021 so if you're still using an older
  version, consider upgrading.
</Admonition>

## Create Certificate/Key Pair

(!docs/pages/includes/database-access/tctl-auth-sign.mdx!)

Create the secrets:

<Tabs>
  <TabItem label="Standalone">
  When connecting to standalone MongoDB, sign certificate for the hostname over
  which Teleport will be connecting to it.

  For example, if your MongoDB server is accessible at `mongo.example.com`
  hostname, run:

  ```bash
  $ tctl auth sign --format=mongodb --host=mongo.example.com --out=mongo --ttl=2190h
  ```

  (!docs/pages/includes/database-access/ttl-note.mdx!)

  The command will create 2 files: `mongo.cas` with Teleport's certificate
  authority and `mongo.crt` with generated certificate and key pair. You will
  need these files to enable mutual TLS on your MongoDB server.
  </TabItem>
  <TabItem label="Replica set">
  When connecting to a MongoDB replica set, sign certificates for each member
  using the hostnames they're accessible at.

  For example, if the first member is accessible at `mongo1.example.com` and
  the second at `mongo2.example.com`, run:

  ```bash
  $ tctl auth sign --format=mongodb --host=mongo1.example.com --out=mongo1 --ttl=2190h
  $ tctl auth sign --format=mongodb --host=mongo2.example.com --out=mongo2 --ttl=2190h
  ```

  (!docs/pages/includes/database-access/ttl-note.mdx!)

  Each command will create 2 files: `mongo1.cas`/`mongo2.cas` with Teleport's
  certificate authority and `mongo1.crt`/`mongo2.crt` with generated certificate
  and key pair. You will need these files to enable mutual TLS on your MongoDB
  servers.
  </TabItem>
</Tabs>

## Configure MongoDB users

Users authenticating with client certificates must be created in the `$external`
MongoDB authentication database.

MongoDB treats the entire `Subject` line of the client certificate as a username.
When connecting to a MongoDB server, say as a user `alice`, Teleport will sign
an ephemeral certificate with `CN=alice` subject.

To create this user in the database you can run the following `mongo` shell
command:

```js
db.getSiblingDB("$external").runCommand(
  {
    createUser: "CN=alice",
    roles: [
      { role: "readWriteAnyDatabase", db: "admin" }
    ]
  }
)
```

Update the [roles](https://docs.mongodb.com/manual/tutorial/manage-users-and-roles/)
accordingly to grant the user appropriate database permissions.

See [Use X.509 Certificates to Authenticate Clients](https://docs.mongodb.com/manual/tutorial/configure-x509-client-authentication/)
in MongoDB documentation for more details.

## Configure MongoDB TLS

Add the following section to your `mongod.conf` configuration file to enable
mutual TLS. Use the files generated above by the `tctl auth sign` command:

<Tabs>
  <TabItem label="MongoDB 3.6 - 4.2">
  ```yaml
  net:
    ssl:
      mode: requireSSL
      PEMKeyFile: /etc/certs/mongo.pem
      CAFile: /etc/certs/mongo.cas
  ```
  </TabItem>
  <TabItem label="MongoDB 4.2+">
  ```yaml
  net:
    tls:
      mode: requireTLS
      certificateKeyFile: /etc/certs/mongo.pem
      CAFile: /etc/certs/mongo.cas
  ```
  </TabItem>
</Tabs>

When configuring a replica set, make sure to do it for each member and use
secrets generated for the particular server.

<Admonition type="note" title="">
  Once mutual TLS has been enabled, you will no longer be able to connect to
  the cluster without providing a valid client certificate. You can use
  `net.tls.allowConnectionsWithoutCertificates` setting to allow connections
  from clients that do not present a certificate.
</Admonition>

See [Configure TLS/SSL](https://docs.mongodb.com/manual/tutorial/configure-ssl/)
in MongoDB documentation for more details.

## Setup Teleport Auth and Proxy Services

Teleport Database Access for MongoDB is available starting from `7.0` release.

(!docs/pages/includes/database-access/start-auth-proxy.mdx!)

### Create User

Create a local Teleport user with the built-in `access` role:

```bash
$ tctl users add --roles=access alice
```

The `access` role allows users to see all connected database servers, but
database names and accounts are restricted to the user's `db_names` and
`db_users` traits. Normally, these traits come from the identity provider. For
the local user you've just created you can update them manually to allow it to
connect to the `admin` database as a `alice` database user.

First, export the user resource:

```bash
$ tctl get users/alice > alice.yaml
```

Update the resource to include the following traits:

```yaml
traits:
  # Database account names the user will be allowed to use.
  db_users:
  - alice
  # Database names the user will be allowed to connect to.
  db_names:
  - admin
```

Update the user:

```bash
$ tctl create alice.yaml -f
```

For more detailed information about database access controls see [RBAC](../rbac.mdx)
documentation.

### Start Database Service with CLI Flags

For a quick try-out, Teleport database service doesn't require a configuration
file and can be launched using a single CLI command:

```sh
$ teleport db start \
   --token=/tmp/token \
   --auth-server=teleport.example.com:3080 \
   --name=example-mongo \
   --protocol=mongodb \
   --uri=mongo.example.com:27017 \
   --labels=env=dev
```

Note that the `--auth-server` flag must point to the Teleport cluster's proxy
endpoint because database service always connects back to the cluster over a
reverse tunnel.

### Start Database Service with Config File

Below is an example of a database service configuration file that proxies
a single self-hosted MongoDB database:

```yaml
teleport:
  # The data_dir should be a different location if running on the same
  # machine as Teleport auth and proxy.
  data_dir: /var/lib/teleport-db
  nodename: teleport-db-instance
  # Teleport invitation token used to join a cluster.
  # can also be passed on start using --token flag
  auth_token: /tmp/token
  # Proxy address to connect to. Note that it has to be the proxy address
  # because database service always connects to the cluster over reverse
  # tunnel.
  auth_servers:
  - teleport.example.com:3080
db_service:
  enabled: "yes"
  # This section contains definitions of all databases proxied by this
  # service, can contain multiple items.
  databases:
    # Name of the database proxy instance, used to reference in CLI.
  - name: "example-mongo"
    # Free-form description of the database proxy instance.
    description: "Example MongoDB"
    # Database protocol.
    protocol: "mongodb"
    # MongoDB endpoint address or connection string, see below for details.
    uri: "mongodb://mongo.example.com:27017"
    # Labels to assign to the database, used in RBAC.
    static_labels:
      env: dev
auth_service:
  enabled: "no"
ssh_service:
  enabled: "no"
proxy_service:
  enabled: "no"
```

<Admonition type="tip" title="Tip">
  A single Teleport process can run multiple different services, for example
  multiple database access proxies as well as running other services such an
  SSH service or an application access proxy.
</Admonition>

Start the database service:

```sh
$ teleport start --config=/path/to/teleport-db.yaml --token=/tmp/token
```

## Standalone vs Replica Set

You can specify either a single connection address as a MongoDB connection URI,
or a [connection string](https://docs.mongodb.com/manual/reference/connection-string/).

<Tabs>
  <TabItem label="Standalone">
  When connecting to a standalone MongoDB server, you can specify the server
  endpoint:

  ```yaml
  uri: "mongo.example.com:27017"
  ```

  Connection string syntax is also accepted:

  ```yaml
  uri: "mongodb://localhost:27017"
  ```
  </TabItem>
  <TabItem label="Replica set">
  When connecting to a MongoDB replica set, specify the connection string as
  a URI:

  ```yaml
  uri: "mongodb://mongo1.example.com:27017,mongo2.example.com:27017/?replicaSet=rs0"
  ```

  By default, Teleport will connect to the primary replica set member. If you'd
  like to connect to a secondary instead, Teleport will respect `readPreference`
  connection string setting:

  ```yaml
  uri: "mongodb://mongo1.example.com:27017,mongo2.example.com:27017/?replicaSet=rs0&readPreference=secondary"
  ```

  Note that if leader election is triggered during the session and the member
  becomes primary, you won't be auto-reconnected.
  </TabItem>
</Tabs>

## Connect

Once the database service has joined the cluster, login to see the available
databases:

```sh
$ tsh login --proxy=teleport.example.com:3080 --user=testuser
$ tsh db ls
Name          Description     Labels
------------- --------------- --------
example-mongo Example MongoDB env=dev
```

Note that you will only be able to see databases your role has access to. See
[RBAC](../rbac.mdx) section for more details.

To connect to a particular database server, first retrieve credentials from
Teleport using `tsh db login` command:

```sh
$ tsh db login example-mongo
```

<Admonition type="tip" title="Tip">
  You can be logged into multiple databases simultaneously.
</Admonition>

You can optionally specify the database name and the user to use by default
when connecting to the database instance:

```sh
$ tsh db login --db-user=alice example-mongo
```

Once logged in, connect to the database:

```bash
$ tsh db connect example-mongo
```

<Admonition type="note" title="Note">
  The `mongo` command-line client should be available in PATH in order to be
  able to connect.
</Admonition>

If you would like to see the native `mongo` shell connect command, run:

```bash
$ tsh db config --format=cmd example-mongo
```

To log out of the database and remove credentials:

```sh
# Remove credentials for a particular database instance.
$ tsh db logout example-mongo
# Remove credentials for all database instances.
$ tsh db logout
```
